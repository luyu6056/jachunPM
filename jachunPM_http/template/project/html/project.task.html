{{template "header.html" .}}
{{template "chart.html" .}}
{{template "datepicker.html" .}}
{{template "datatable.html" .}}
<div id="mainMenu" class="clearfix">
	<div id="sidebarHeader">
		<div class="title">
			<?php
			if(!empty($productID))
			{
					$product    = $this->product->getById($productID);
					$removeLink = (eq browseType "byproduct") ? inlink('task', "projectID=$projectID&browseType=$status&param=0&orderBy=$orderBy&recTotal=0&recPerPage={$pager->recPerPage}") : 'javascript:removeCookieByKey("productBrowseParam")';
					$product->name;
					html_a $removeLink  "<i class='icon icon-sm icon-close'></i>" ""  "class='text-muted'"
			}
			elseif(!empty($moduleID))
			{
					$module     = $this->tree->getById($moduleID);
					$removeLink = (eq browseType "bymodule") ? inlink('task', "projectID=$projectID&browseType=$status&param=0&orderBy=$orderBy&recTotal=0&recPerPage={$pager->recPerPage}") : 'javascript:removeCookieByKey("moduleBrowseParam")';
					$module->name;
					html_a $removeLink  "<i class='icon icon-sm icon-close'></i>" ""  "class='text-muted'"
			}
			else
			{
					$this->app->loadLang('tree');
					$this->lang->tree->all;
			}
			?>
		</div>
	</div>
	<div class="btn-toolbar pull-left">
		
		<a class="btn btn-link querybox-toggle" id='bysearchTab'><i class="icon icon-search muted"></i> {{.Lang.product.searchStory}}</a>
	</div>
	<div class="btn-toolbar pull-right">
		<?php
		if(!isset($browseType)) $browseType = '';
		if(!isset($orderBy))    $orderBy = '';
		common_printIcon "task" "report"  "project=$projectID&browseType=$browseType" "', 'button', 'bar-chart muted"
		?>

		<div class="btn-group dropdown-hover">
			<button class="btn btn-link" data-toggle="dropdown"><i class="icon icon-export muted"></i> <span class="text">{{.Lang.export}}</span> <span class="caret"></span></button>
			<ul class="dropdown-menu pull-right" id='exportActionMenu'>
				<?php
				$class = common_hasPriv "task" "export" ? '' : "class=disabled";
				$misc  = common_hasPriv "task" "export" ? "class='export'" : "class=disabled";
				$link  = common_hasPriv "task" "export') ? (helper_createLink 'task" "export"  "project=$projectID&orderBy=$orderBy&type=$browseType" : '#';
				"<li $class>" . html_a $link  .Lang.story.export ""  $misc . "</li>";
				?>
				
				<?php
				$class = common_hasPriv "task" "exportfile" ? '' : "class=disabled";
				$misc  = common_hasPriv "task" "exportfile" ? "class='exportfile'" : "class=disabled";
				$link  = common_hasPriv "task" "exportfile') ? (helper_createLink 'task" "exportfile"  "project=$projectID&orderBy=id&type=$browseType" : '#';
				"<li $class>" . html_a $link "<span>'..Lang.project.exportfile.'</span>" "" . "</li>";
				?>
			</ul>
		</div>

		<div class="btn-group dropdown-hover">
			<button class="btn btn-link" data-toggle="dropdown"><i class="icon icon-import muted"></i> <span class="text">{{.Lang.import}}</span> <span class="caret"></span></button>
			<ul class="dropdown-menu pull-right" id='importActionMenu'>
				<?php
				$class = common_hasPriv "project" "importTask" ? '' : "class=disabled";
				$misc  = common_hasPriv "project" "importTask" ? "class='import'" : "class=disabled";
				$link  = common_hasPriv "project" "importTask') ? (helper_createLink 'project" "importTask"  "project=$project->id" : '#';
				"<li $class>" . html_a $link  .Lang.project.importTask ""  $misc . "</li>";

				$class = common_hasPriv "project" "importBug" ? '' : "class=disabled";
				$misc  = common_hasPriv "project" "importBug" ? "class='import'" : "class=disabled";
				$link  = common_hasPriv "project" "importBug') ? (helper_createLink 'project" "importBug"  "project=$project->id" : '#';
				"<li $class>" . html_a $link  .Lang.project.importBug ""  $misc . "</li>";
				?>
			</ul>
		</div>
		<?php
		$checkObject = new stdclass();
		$checkObject->project = $projectID;
		$link = (helper_createLink 'task', 'batchCreate', "project=$projectID" . (isset($moduleID) ? "&storyID=&moduleID=$moduleID" : ''));
		if(common_hasPriv "task" "batchCreate"  $checkObject)) html_a $link  "<i class='icon icon-plus'></i> {.Lang.task.batchCreate}" ""  "class='btn btn btn-secondary'"

		$link = (helper_createLink 'task', 'create', "project=$projectID" . (isset($moduleID ? "&storyID=&moduleID=$moduleID" : ''));
		if(common_hasPriv "task" "create"  $checkObject)) html::a($link  "<i class='icon icon-plus'></i> {.Lang.task.create}", '', "class='btn btn-primary'"
		?>
	</div>
</div>
<div id="mainContent" class="main-row fade">
	<div class="side-col" id="sidebar">
		<div class="sidebar-toggle"><i class="icon icon-angle-left"></i></div>
		<div class="cell">
			{{.Data.moduleTree}}
			<div class="text-center">
				{{common_printLink . "tree" "browsetask"  (strAdd "rootID=" .Data.projectID "&productID=0")  .Lang.tree.manage "" "class='btn btn-info btn-wide'"}}
				<hr class="space-sm" />
			</div>
		</div>
		<div class="cell2">
			<div class="text-center">
			<a class="btn btn-info btn-wide">{{.Lang.project.specFile}}</a>
				<hr class="space-sm" />
				{{common_printLink . "project" "showFile"  (strAdd "projectID=" .Data.projectID "&spec=modelFile")  (getValue .Lang.file.specFile "modelFile") "" "id='batchCreate' class='text-secondary small iframe' data-width='80%'" "" "true"}}
				<hr class="space-sm" />
				{{common_printLink . "project" "showFile" (strAdd "projectID=" .Data.projectID "&spec=animationFile")  (getValue .Lang.file.specFile "animationFile") "" "id='batchCreate' class='text-secondary small iframe' data-width='80%'" "" "true"}}
				<hr class="space-sm" />
				{{common_printLink . "project" "showFile"  (strAdd "projectID=" .Data.projectID "&spec=specialFile")  (getValue .Lang.file.specFile "specialFile") "" "id='batchCreate' class='text-secondary small iframe' data-width='80%'" "" "true"}}
				<hr class="space-sm" />
				{{common_printLink . "project" "showFile"  (strAdd "projectID=" .Data.projectID "&spec=bindingFile")  (getValue .Lang.file.specFile "bindingFile") "" "id='batchCreate' class='text-secondary small iframe' data-width='80%'" "" "true"}}
				<hr class="space-sm" />
				{{common_printLink . "project" "showFile"  (strAdd "projectID=" .Data.projectID "&spec=twodFile")  (getValue .Lang.file.specFile "twodFile") "" "id='batchCreate' class='text-secondary small iframe' data-width='80%'" "" "true"}}
				<hr class="space-sm" />
				{{common_printLink . "project" "showFile"  (strAdd "projectID=" .Data.projectID "&spec=otherFile")  (getValue .Lang.file.specFile "otherFile") "" "id='batchCreate' class='text-secondary small iframe' data-width='80%'" "" "true"}}
				<hr class="space-sm" />
			</div>
		</div>
	</div>
	
	<div class="main-col">
		<div class="cell{{if eq .Data.browseType "bysearch"}} show{{end}}" id="queryBox"></div>
		{{if not .Data.tasks}}
		<div class="table-empty-tip">
			<p>
				<span class="text-muted">{{.Lang.task.noTask}}</span>
				{{if common_hasPriv . "task" "create"  .Data.checkObject}}
				<span class="text-muted">{{.Lang.common.youCould}}</span>
				{{html_a (helper_createLink "task" "create"  "project=" .Data.projectID (or (and .Data.moduleID (strAdd "&storyID=&moduleID=" .Data.moduleID)) ""))  (strAdd "<i class='icon icon-plus'></i> " .Lang.task.create) "" "class='btn btn-info'"}}
				{{end}}
			</p>
		</div>
		{{else}}
		<form class="main-table table-task skip-iframe-modal" method="post" id='projectTaskForm'>
			<div class="table-header fixed-right">
				<nav class="btn-toolbar pull-right"></nav>
			</div>

			<?php
			
			$vars         = "projectID=$project->id&status=$status&parma=$param&orderBy=%s&recTotal=$recTotal&recPerPage=$recPerPage";

			if($useDatatable) include '../../common/view/datatable.html.php';

			$customFields = $this->datatable->getSetting('project');
		 
			if((eq project->type "ops"))
			{
					foreach($customFields as $id => (eq customField)
					{
							if($customField->id "story")) unset($customFields[$id]);
					}
			}
			$widths  = $this->datatable->setFixedFieldWidth($customFields);
			$columns = 0;
			?>
			{{if not .Data.useDatatable}}<div class="table-responsive">{{end}}
			<table class='table has-sort-head{{if .Data.useDatatable}} datatable{{end}}' id='taskList' data-fixed-left-width='{{index .Data.widths "leftWidth"}}' data-fixed-right-width='{{index .Data.widths "rightWidth"}}'>
				<thead>
					<tr>
					<?php
					foreach($customFields as $field)
					{
							if($field->show)
							{
									$this->datatable->printHead($field, $orderBy, $vars);
									$columns++;
							}
					}
					?>
					</tr>
				</thead>
				<tbody>
					{{.Data.taskCell}}
				</tbody>
			</table>
			{{if not .Data.useDatatable}}</div>{{end}}

			<div class="table-footer">
				<div class="checkbox-primary check-all"><label>{{.Lang.common.selectAll}}</label></div>
				<div class="table-actions btn-toolbar">
					<?php
					$canBatchEdit         = common_hasPriv "task" "batchEdit"  !empty($task ? $task : null);
					$canBatchClose        = (common_hasPriv "task" "batchClose"  !empty($task ? $task : null) && strtolower((ne browseType) "closedBy"));
					$canBatchCancel       = common_hasPriv "task" "batchCancel"  !empty($task ? $task : null);
					$canbatchexamine       = common_hasPriv "task" "batchexamine"  !empty($task ? $task : null);
					$canbatchproofreading       = common_hasPriv "task" "batchproofreading"  !empty($task ? $task : null);
					{{$canBatchChangeModule := common_hasPriv . "task" "batchChangeModule"  }}
					{{$canBatchAssignTo     := common_hasPriv "task" "batchAssignTo"  }}
					{{$canBatchPlaceOrder       := common_hasPriv "task" "placeOrder" }}
					?>
					<div class='btn-group dropup'>
						<?php
						$actionLink = (helper_createLink 'task', 'batchEdit', "projectID=$projectID");
						$disabled   = $canBatchEdit ? '' : "disabled='disabled'";

						html_commonButton .Lang.edit  "data-form-action='$actionLink' $disabled"
						"<button type='button' class='btn dropdown-toggle' data-toggle='dropdown'><span class='caret'></span></button>";
						"<ul class='dropdown-menu'>";

						$actionLink = (helper_createLink 'task', 'batchClose');
						$misc = $canBatchClose ? "onclick=\"setFormAction('$actionLink', 'hiddenwin', '#taskList')\"" : "class='disabled'";
						"<li>" . html_a "#"  .Lang.close ""  $misc . "</li>";

						$actionLink = (helper_createLink 'task', 'batchCancel');
						$misc = $canBatchCancel ? "onclick=\"setFormAction('$actionLink', 'hiddenwin', '#taskList')\"" : "class='disabled'";
						"<li>" . html_a "#"  .Lang.task.cancel ""  $misc . "</li>";
						"</ul>";
						?>
					</div>
					
					<div class='btn-group dropup'>
						<?php
						$actionLink = (helper_createLink 'task', 'batchEdit', "projectID=$projectID");
						$disabled   = $canBatchEdit ? '' : "disabled='disabled'";

						html_commonButton .Lang.project.batchEdit  "data-form-action='$actionLink' $disabled"
						"<button type='button' class='btn dropdown-toggle' data-toggle='dropdown'><span class='caret'></span></button>";
						"<ul class='dropdown-menu'>";

						$actionLink = (helper_createLink 'task', 'batchexamine');
						$misc = $canbatchexamine ? "onclick=\"setFormAction('$actionLink', 'hiddenwin', '#taskList')\"" : "class='disabled'";
						"<li>" . html_a "#"  .Lang.task.batchexamine  ""  $misc . "</li>";

						$actionLink = (helper_createLink 'task', 'batchproofreading');
						$misc = $canbatchproofreading ? "onclick=\"setFormAction('$actionLink', 'hiddenwin', '#taskList')\"" : "class='disabled'";
						"<li>" . html_a "#"  .Lang.task.batchproofreading ""  $misc . "</li>";
						
						$actionLink = (helper_createLink 'task', 'batchexaminec');
						$misc = $canbatchexamine ? "onclick=\"setFormAction('$actionLink', 'hiddenwin', '#taskList')\"" : "class='disabled'";
						"<li>" . html_a "#"  .Lang.task.batchexaminec ""  $misc . "</li>";
						
						$actionLink = (helper_createLink 'task', 'batchproofreadingc');
						$misc = $canbatchproofreading ? "onclick=\"setFormAction('$actionLink', 'hiddenwin', '#taskList')\"" : "class='disabled'";
						"<li>" . html_a "#"  .Lang.task.batchproofreadingc ""  $misc . "</li>";

						$actionLink = (helper_createLink 'task', 'finishall',"projectID=$projectID");
						$misc = $canbatchproofreading ? "onclick=\"setFormAction('$actionLink', '', '#taskList')\"" : "class='disabled'";
						"<li>" . html_a "#"  .Lang.task.finishall ""  $misc . "</li>";

						$actionLink = (helper_createLink 'task', 'exportfinish');
						$misc = $canbatchproofreading ? "onclick=\"setFormAction('$actionLink', 'hiddenwin', '#taskList')\"" : "class='disabled'";
						"<li>" . html_a "#"  .Lang.task.exportfinish ""  $misc . "</li>";

						
						$actionLink = (helper_createLink 'task', 'placeOrder',"action=1");
						$misc = $canBatchPlaceOrder ? "onclick=\"setFormAction('$actionLink', 'hiddenwin', '#taskList')\"" : "class='disabled'";
						"<li>" . html_a "#"  .Lang.task.setPlaceOrder ""  $misc . "</li>";

						$actionLink = (helper_createLink 'task', 'placeOrder',"action=0");
						$misc = $canBatchPlaceOrder ? "onclick=\"setFormAction('$actionLink', 'hiddenwin', '#taskList')\"" : "class='disabled'";
						"<li>" . html_a "#"  .Lang.task.cancelPlaceOrder ""  $misc . "</li>";
						"</ul>";
						?>
					</div>
					
					{{if $canBatchChangeModule}}
					<div class="btn-group dropup">
						<button data-toggle="dropdown" type="button" class="btn">{{.Lang.story.moduleAB}} <span class="caret"></span></button>
						{{$withSearch := eq (len .Data.modules) 10}}
						{{if $withSearch}}
						<div class="dropdown-menu search-list search-box-sink" data-ride="searchList">
							<div class="input-control search-box has-icon-left has-icon-right search-example">
								<input id="userSearchBox" type="search" autocomplete="off" class="form-control search-input">
								<label for="userSearchBox" class="input-control-icon-left search-icon"><i class="icon icon-search"></i></label>
								<a class="input-control-icon-right search-clear-btn"><i class="icon icon-close icon-sm"></i></a>
							</div>
						
						{{else}}
						<div class="dropdown-menu search-list">
						{{end}}
							<div class="list-group">
								<?php
								foreach($modules as $moduleId => $module)
								{
										$searchKey = $withSearch ? ('data-key="' . zget($modulesPinYin, $module, '') . '"') : '';
										$actionLink = (helper_createLink 'task', 'batchChangeModule', "moduleID=$moduleId");
										html_a "#"  $module ""  "$searchKey onclick=\"setFormAction('$actionLink', 'hiddenwin', '#taskList'\"");
								}
								?>
							</div>
						</div>
					</div>
					{{end}}

					{{if $canBatchAssignTo}}
					<div class="btn-group dropup">
						<button data-toggle="dropdown" type="button" class="btn">{{.Lang.story.assignedTo}} <span class="caret"></span></button>
						<?php
						{{$withSearch := eq (len .Data.memberPairs) 10}}
						$actionLink = (helper_createLink 'task', 'batchAssignTo', "projectID=$projectID");
						html_select "assignedTo"  $memberPairs "" "class='hidden'"
						{{if $withSearch}}
						
						<div class="dropdown-menu search-list search-box-sink" data-ride="searchList">
							<div class="input-control search-box has-icon-left has-icon-right search-example">
								<input id="userSearchBox" type="search" autocomplete="off" class="form-control search-input">
								<label for="userSearchBox" class="input-control-icon-left search-icon"><i class="icon icon-search"></i></label>
								<a class="input-control-icon-right search-clear-btn"><i class="icon icon-close icon-sm"></i></a>
							</div>
						
						{{else}}
						<div class="dropdown-menu search-list">
						{{end}}
							<div class="list-group">
								<?php
								foreach($memberPairs as $key => $value)
								{
										if(empty($key)) continue;
										$searchKey = $withSearch ? ('data-key="' . zget($membersPinYin, $value, '') . " @$key\"") : "data-key='@$key'";
										html_a "javascript:$(\".table-actions #assignedTo\".val(\"$key\");setFormAction(\"$actionLink\", \"hiddenwin\", \"#taskList\")", $value, '', $searchKey);
								}
								?>
							</div>
						</div>
					</div>
					{{end}}
				</div>
				<div class="table-statistic">{{.Data.summary}}</div>
				{{pager_show . "right" "pagerjs"}}
			</div>
		</form>
		{{end}}
	</div>
</div>
<script>
$(function()
{
	var moduleID={{.Data.moduleID}},productID={{.Data.productID}},projectID={{.Data.projectID}},browseType={{.Data.browseType}},replaceID="taskList";
	$('#exportActionMenu li span').each(function(index  el {
		$(this).unbind().click(function(event) {
			if(confirm('是否要导出所有文件')) $(this).parents().click();
		});
	});
		// Update table summary text
		var checkedSummary = '{{.Lang.project.checkedSummary}}';
		$('#projectTaskForm').table(
		{
				statisticCreator: function(table)
				{
						var $checkedRows = table.getTable().find(table.isDataTable ? '.datatable-row-left.checked' : 'tbody>tr.checked');
						var $originTable = table.isDataTable ? table.$.find('.datatable-origin') : null;
						var checkedTotal = $checkedRows.length;
						if(!checkedTotal) return;

						var checkedWait     = 0;
						var checkedDoing    = 0;
						var checkedEstimate = 0;
						var checkedConsumed = 0;
						var checkedLeft     = 0;
						$checkedRows.each(function()
						{
								var $row = $(this);
								if ($originTable)
								{
										$row = $originTable.find('tbody>tr[data-id="' + $row.data('id') + '"]');
								}
								var data = $row.data();
								var status = data.status;
								if(status === 'wait') checkedWait++;
								if(status === 'doing') checkedDoing++;
								if(!$row.hasClass('table-children'))
								{
										if(status !== 'cancel')
										{
												checkedEstimate += Number(data.estimate);
												checkedConsumed += Number(data.consumed);
										}
										if(status != 'cancel' && status != 'closed') checkedLeft += Number(data.left);
								}
						});
						return checkedSummary.replace('%total%', checkedTotal).replace('%wait%', checkedWait)
							.replace('%doing%', checkedDoing)
							.replace('%estimate%', checkedEstimate.toFixed(1))
							.replace('%consumed%', checkedConsumed.toFixed(1))
							.replace('%left%', checkedLeft.toFixed(1));
				}
		})
});
var taskhtml={{.Data.taskhtml}};
var useDatatable={{if .Data.useDatatable}}true{{else}}false{{end}};
var datatableSetting={{.Data.customFields}};
var add=true;
$(function()
{
while($(window).height()==$(document).height() && taskhtml.length){
	addtask()
}
});
$(window).scroll(function(){
	if(add && taskhtml.length && $(document).height()-$(document).scrollTop()-$(window).height()<400){
		add=false;
		addtask()
	}
});

function addtask(){
	var row=$('#datatable-taskList .datatable-rows .fixed-left tr').length;
		var html=taskhtml.splice(0,10);
		$('#taskList tbody').append(html.join(''));
		if(useDatatable){
			var htmlleft=[],htmlno=[],htmlright=[];
			for(var i in html){
				var tr=html[i].split('<tr');
				for(var k=1;k<tr.length;k++){
					var td=tr[k].split('<td');
					var tdleft=[],tdno=[],tdright=[];
					var index=0;
					for(var j in datatableSetting){
						var setting=datatableSetting[j];
						if(!setting.show) continue;
						title=td[index+1].match(/title='([^']+)'/)?td[index+1].match(/title='([^']+)'/)[1]:'';
						switch(setting.fixed){
							case 'left':
							tdleft.push('<td class="datatable-cell '+td[index+1].match(/class='([^']+)'/)[1]+'" colspan="1" data-row="'+row+'" data-index="'+index+'" data-flex="'+$('#taskList thead tr th').eq(index).attr('data-flex')+'" data-type="string" title="'+title+'" style="width: '+$('#taskList thead tr th').eq(index).attr('data-width')+';">'+td[index+1].replace(/ class='([^']+)'\s*(title='[^']+')?>/,''));
							break;
							case 'no':
							tdno.push('<td class="datatable-cell '+td[index+1].match(/class='([^']+)'/)[1]+'" colspan="1" data-row="'+row+'" data-index="'+index+'" data-flex="'+$('#taskList thead tr th').eq(index).attr('data-flex')+'" data-type="string" title="'+title+'" style="width: '+$('#taskList thead tr th').eq(index).attr('data-width')+';">'+td[index+1].replace(/ class='([^']+)'\s*(title='[^']+')?>/,''));
							break;
							case 'right':
							tdright.push('<td class="datatable-cell '+td[index+1].match(/class='([^']+)'/)[1]+'" colspan="1" data-row="'+row+'" data-index="'+index+'" data-flex="'+$('#taskList thead tr th').eq(index).attr('data-flex')+'" data-type="string" title="'+title+'" style="width: '+$('#taskList thead tr th').eq(index).attr('data-width')+';">'+td[index+1].replace(/ class='([^']+)'\s*(title='[^']+')?>/,''));
							break;
						}
						index++;
					}
					trclass=td[0].match(/class='([^']+)'/)?td[0].match(/class='([^']+)'/)[1]:'';
					htmlleft.push('<tr class="datatable-row '+trclass+' datatable-row-left" data-index="'+row+'" data-id="'+td[0].match(/data-id='([^']+)'/)[1]+'">'+tdleft.join('')+'</tr>');
					htmlno.push('<tr class="datatable-row '+trclass+' datatable-row-flex" data-index="'+row+'" data-id="'+td[0].match(/data-id='([^']+)'/)[1]+'">'+tdno.join('')+'</tr>');
					htmlright.push('<tr class="datatable-row '+trclass+' datatable-row-right" data-index="'+row+'" data-id="'+td[0].match(/data-id='([^']+)'/)[1]+'">'+tdright.join('')+'</tr>');
					row++;
				}
				
			}
			$('#datatable-taskList .datatable-rows .fixed-left tbody').append(htmlleft.join(''));
		$('#datatable-taskList .datatable-rows .flexarea tbody').append(htmlno.join(''));
		$('#datatable-taskList .datatable-rows .fixed-right tbody').append(htmlright.join(''));
		}
		add=true;
}
</script>
{{template "footer.html" .}}
