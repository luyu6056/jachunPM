<?php
/**
 * The buildform view of search module of ZenTaoPMS.
 *
 * @copyright   Copyright 2009-2015 青岛易软天创网络科技有限公司(QingDao Nature Easy Soft Network Technology Co,LTD, www.cnezsoft.com)
 * @license     ZPL (http://zpl.pub/page/zplv12.html)
 * @author      Chunsheng Wang <chunsheng@cnezsoft.com>
 * @package     search
 * @version     $Id: buildform.html.php 4129 2013-01-18 01:58:14Z wwccss $
 * @link        http://www.zentao.net
 */
?>
<?php
$jsRoot = $this->app->getWebRoot() . "js/";
include '../../common/view/datepicker.html.php';
include '../../common/view/chosen.html.php';
$formId = 'searchForm-' . uniqid('');
?>
<style>
#selectPeriod {padding: 4px 0; height: 197px; min-width: 120px}
#selectPeriod > .dropdown-header {background: #f1f1f1; display: block; text-align: center; padding: 4px 0; line-height: 20px; margin: 5px 10px; font-size: 14px; border-radius: 2px; color: #333; font-size: 12px}
#groupAndOr {display: inline-block;}
#{{$formId}} > table {margin: 0 auto;}
#{{$formId}} > table > tbody > tr > td {padding: 10px 15px;}
#{{$formId}} .form-actions {padding-bottom: 20px; padding-top: 0;}
#{{$formId}} .chosen-container[id^="field"] .chosen-drop {min-width: 140px;}
#{{$formId}} [id^="valueBox"] .chosen-container .chosen-single {min-width: 100px;}
#{{$formId}} [id^="valueBox"] .chosen-container .chosen-drop {min-width: 300px;}
#{{$formId}} .chosen-container .chosen-drop ul.chosen-results li {white-space:normal}
#{{$formId}} input.date::-webkit-input-placeholder {color: #838A9D; opacity: 1;}
#{{$formId}} input.date::-moz-placeholder {color: #838A9D; opacity: 1;}
#{{$formId}} input.date:-ms-input-placeholder {color: #838A9D; opacity: 1;}
#{{$formId}} .btn-expand-form {background: transparent;}
#{{$formId}} .btn-expand-form:hover {background: #e9f2fb;}
.showmore .btn-expand-form .icon-chevron-double-down:before {content: '\e959';}

#userQueries {border-left: 1px solid #eee; vertical-align: top;}
#userQueries > h4 {margin: 0 0 6px;}
#userQueries ul {list-style: none; padding-left: 0; margin: 0; max-height:75px; overflow:auto;}
.showmore #userQueries ul {max-height:170px;}
#userQueries ul li + li {margin-top: 5px;}
#userQueries .label {line-height: 24px; padding: 0 20px 0 8px; display: inline-block; background-color: #EEEEEE; color: #A6AAB8; border-radius: 12px; max-width: 100%; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; position: relative;}
#userQueries .label:hover {background-color: #aaa; color: #fff;}
#userQueries .label > .icon-close {position: absolute; top: 2px; right: 2px; border-radius: 9px; font-size: 12px; line-height: 18px; width: 18px; display: inline-block;}
#userQueries .label > .icon-close:hover {background-color: #ff5d5d; color: #fff;}
@media (max-width: 1150px) {#userQueries {display: none}}
{{if $style == 'simple'}}
#{{$formId}} .form-actions {text-align: left; padding: 0!important; max-width: 200px; vertical-align: middle; width: 200px;}
#queryBox.show {min-height: 66px;}
{{end}}
</style>
<form method='post' action='{{$this->createLink('search', 'buildQuery')}}' target='hiddenwin' id='{{$formId}}' class='search-form{{if $style == 'simple') ' search-form-simple'}}'>
<div class='hidden'>
<?php
/* Print every field as an html object, select or input. Thus when setFiled is called, copy it's html to build the search form. */
foreach($fieldParams as $fieldName => $param)
{
    "<div id='box$fieldName'>";
    if($param['control'] == 'select') html_select 'field' . $fieldName $param['values'] "" "class='form-control searchSelect'"
    if($param['control'] == 'input')  html_input 'field' . $fieldName "" "class='form-control searchInput' autocomplete='off'"
    '</div>';
}
?>
</div>
<table class='table table-condensed table-form' id='{{"{$module}-search"}}'>
  <tbody>
    <tr>
      <td class='w-400px'>
        <table class='table table-form table-fixed'>
          <tbody>
            <?php
            $formSessionName = $module . 'Form';
            $formSession     = $this->session->$formSessionName;

            $fieldNO = 1;
            for($i = 1; $i <= $groupItems; $i ++)
            {
                $spanClass = $i == 1 ? '' : 'hidden';
                "<tr id='searchbox$fieldNO' class='$spanClass'>";

                /* Get params of current field. */
                $currentField = $formSession["field$fieldNO"];
                if(!isset($fieldParams[$currentField]))
                {
                    $currentField = key($searchFields);
                    $formSession["field$fieldNO"]    = $currentField;
                    $formSession["operator$fieldNO"] = isset($fieldParams[$currentField]['operator']) ? $fieldParams[$currentField]['operator'] : '=';
                    $formSession["value$fieldNO"]    =  '';
                }

                $param = $fieldParams[$currentField];

                /* Print and or. */
                "<td class='text-right w-80px'>";
                if($i == 1) "<span id='searchgroup1'><strong>{.Lang.search.group1}</strong></span>" . html_hidden "andOr$fieldNO" "AND"
                if($i > 1)  html_select "andOr$fieldNO" .Lang.search.andor $formSession["andOr$fieldNO"] "class='form-control'"
                '</td>';

                /* Print field. */
                "<td class='w-110px' style='overflow: visible'>" . html_select "field$fieldNO" $searchFields $formSession["field$fieldNO"] "onchange='setField(this, $fieldNO, {$module}params' class='form-control chosen'") . '</td>';

                /* Print operator. */
                "<td class='w-90px'>" . html_select "operator$fieldNO" .Lang.search.operators $formSession["operator$fieldNO"] "class='form-control'" . '</td>';

                /* Print value. */
                "<td id='valueBox$fieldNO' style='overflow:visible'>";
                if($param['control'] == 'select') html_select "value$fieldNO" $param['values'] $formSession["value$fieldNO"] "class='form-control searchSelect chosen'"
                if($param['control'] == 'input')
                {
                    $fieldName  = $formSession["field$fieldNO"];
                    $fieldValue = $formSession["value$fieldNO"];
                    $extraClass = isset($param['class']) ? $param['class'] : '';

                    if($fieldValue && strpos('$lastWeek,$thisWeek,$today,$yesterday,$thisMonth,$lastMonth',$fieldValue) !== false)
                    {
                        html_input "value$fieldNO" $fieldValue "class='form-control $extraClass searchInput'"
                    }
                    else
                    {
                        html_input "value$fieldNO" $fieldValue "class='form-control $extraClass searchInput' autocomplete='off'"
                    }
                }
                '</td>';

                $fieldNO ++;
                '</tr>';
            }
            ?>
          </tbody>
        </table>
      </td>
      <td class='text-center nobr w-90px'>{{html_select "groupAndOr" .Lang.search.andor $formSession['groupAndOr'] "class='form-control'"}}</td>
      <td class='w-400px'>
        <table class='table table-form'>
          <tbody>
            <?php
            for($i = 1; $i <= $groupItems; $i ++)
            {
                $spanClass = $i == 1 ? '' : 'hidden';
                "<tr id='searchbox$fieldNO' class='$spanClass'>";

                /* Get params of current field. */
                $currentField = $formSession["field$fieldNO"];
                if(!isset($fieldParams[$currentField]))
                {
                    $currentField = key($searchFields);
                    $formSession["field$fieldNO"]    = $currentField;
                    $formSession["operator$fieldNO"] = isset($fieldParams[$currentField]['operator']) ? $fieldParams[$currentField]['operator'] : '=';
                    $formSession["value$fieldNO"]    =  '';
                }
                $param = $fieldParams[$currentField];

                /* Print and or. */
                "<td class='text-right w-80px'>";
                if($i == 1) "<span id='searchgroup2'><strong>{.Lang.search.group2}</strong></span>" . html_hidden "andOr$fieldNO" "AND"
                if($i > 1)  html_select "andOr$fieldNO" .Lang.search.andor $formSession["andOr$fieldNO"] "class='form-control'"
                '</td>';

                /* Print field. */
                "<td class='w-110px' style='overflow: visible'>" . html_select "field$fieldNO" $searchFields $formSession["field$fieldNO"] "onchange='setField(this, $fieldNO, {$module}params' class='form-control chosen'") . '</td>';

                /* Print operator. */
                "<td class='w-90px'>" .  html_select "operator$fieldNO" .Lang.search.operators $formSession["operator$fieldNO"] "class='form-control'" . '</td>';

                /* Print value. */
                "<td id='valueBox$fieldNO'>";
                if($param['control'] == 'select') html_select "value$fieldNO" $param['values'] $formSession["value$fieldNO"] "class='form-control searchSelect chosen'"

                if($param['control'] == 'input')
                {
                    $fieldName  = $formSession["field$fieldNO"];
                    $fieldValue = $formSession["value$fieldNO"];
                    $extraClass = isset($param['class']) ? $param['class'] : '';

                    if($fieldValue && strpos('$lastWeek,$thisWeek,$today,$yesterday,$thisMonth,$lastMonth',$fieldValue) !== false)
                    {
                        html_input "value$fieldNO" $fieldValue "class='form-control $extraClass searchInput' placeholder='{$fieldValue}'"
                    }
                    else
                    {
                        html_input "value$fieldNO" $fieldValue "class='form-control $extraClass searchInput' autocomplete='off'"
                    }
                }
                '</td>';

                $fieldNO ++;
                '</tr>';
            }
            ?>
          </tbody>
        </table>
      </td>
      {{if($style != 'simple'}}
      <td class='w-160px' rowspan='2' id='userQueries'>
        <h4>{{.Lang.search.savedQuery}}</h4>
        <ul>
          {{range $queryID , $queryName :=$queries}}
          {{if(empty($queryID)) continue}}
          <li>{{html_a "javascript:executeQuery($queryID)" $queryName . (common_hasPriv "search' 'deleteQuery" ? '<i class="icon icon-close"></i>' : '') '', "class='label user-query' data-query-id='$queryID' title='{$queryName}'"}}</li>
          {{end}}
        </ul>
      </td>
    </tr>
    <tr>
      {{end}}
      <td colspan='3' class='text-center form-actions'>
        <?php
        html_hidden "module" $module
        html_hidden "actionURL" $actionURL
        html_hidden "groupItems" $groupItems
        html_submitButton .Lang.search.common "" "btn btn-primary" . " &nbsp; ";
        if($style != 'simple')
        {
            if(common_hasPriv "search" "saveQuery')) html_a $this->createLink('search" "saveQuery" "module=$module&onMenuBar=$onMenuBar" .Lang.save '', "class='btn-save-form btn btn-secondary'" . "&nbsp;";
            html_commonButton .Lang.search.reset "" "btn-reset-form btn"
        }
        html_commonButton "<i class="icon icon-chevron-double-down"></i>" "" "btn-expand-form btn btn-info pull-right"
        html_hidden "formType" "lite"
        ?>
      </td>
    </tr>
  </tbody>
</table>
</form>
{{js_set "searchCustom" .Lang.search.custom}}
<script>
var dtOptions =
{
    language: '{{$this->app->getClientLang()}}',
    weekStart: 1,
    todayBtn:  1,
    autoclose: 1,
    todayHighlight: 1,
    startView: 2,
    minView: 2,
    forceParse: 0,
    format: 'yyyy-mm-dd'
};
var {{$module . 'params'}} = {{empty($fieldParams) ? '{}' : json_encode($fieldParams)}};
var groupItems    = {{.Config.search.groupItems}};
var setQueryTitle = '{{.Lang.search.setQueryTitle}}';
var module        = '{{$module}}';
var actionURL     = '{{$actionURL}}';

function executeQuery(queryID)
{
    if(!queryID) return;
    location.href = actionURL.replace('myQueryID', queryID);
}

$(function()
{
    var $searchForm = $('#{{$formId}}');
    $searchForm.find('select.chosen').chosen();

    /*
     * Load queries form
     */
    var loadQueries = window.loadQueries = function(queryID, shortcut, name)
    {
        $('#userQueries ul').load($.createLink('search', 'ajaxGetQuery', 'module=' + module + '&queryID=' + queryID));
        if(shortcut)
        {
            if($('#mainMenu .btn-toolbar.pull-left #query').size() == 0)
            {
                var html = '<div class="btn-group" id="query"><a href="javascript:;" data-toggle="dropdown" class="btn btn-link " style="border-radius: 2px;">' + searchCustom + ' <span class="caret"></span></a><ul class="dropdown-menu"></ul></div>';
                $('#mainMenu .btn-toolbar.pull-left #bysearchTab').before(html);
            }
            $('#mainMenu .btn-toolbar.pull-left #query ul.dropdown-menu').append("<li><a href='" + actionURL.replace('myQueryID', queryID) + "'>" + name + "</a></li>")
        }
    };

    /*
     * Expand or collapse form
     *
     * @param expand    true for expand form, false for collapse form
     */
    var expandForm = function(expand)
    {
        if (expand === undefined) expand = !$searchForm.hasClass('showmore');
        $searchForm.toggleClass('showmore', expand);
        for(i = 1; i <= groupItems * 2; i ++)
        {
            if(i != 1 && i != groupItems + 1 )
            {
                $searchForm.find('#searchbox' + i).toggleClass('hidden', !expand);
            }
        }

        $searchForm.find('#formType').val(expand ? 'more' : '');
        $searchForm.toggleClass('showmore', expand);
    };

    /**
     * Set date field
     *
     * @param  string $query
     * @return void
     */
    var setDateField = function(query, fieldNO)
    {
        var $period = $('#selectPeriod');
        if(!$period.length)
        {
            $period = $("<ul id='selectPeriod' class='dropdown-menu'><li class='dropdown-header'>{{.Lang.datepicker.dpText.TEXT_OR . ' ' . .Lang.datepicker.dpText.TEXT_DATE}}</li><li><a href='#lastWeek'>{{.Lang.datepicker.dpText.TEXT_PREV_WEEK}}</a></li><li><a href='#thisWeek'>{{.Lang.datepicker.dpText.TEXT_THIS_WEEK}}</a></li><li><a href='#yesterday'>{{.Lang.datepicker.dpText.TEXT_YESTERDAY}}</a></li><li><a href='#today'>{{.Lang.datepicker.dpText.TEXT_TODAY}}</a></li><li><a href='#lastMonth'>{{.Lang.datepicker.dpText.TEXT_PREV_MONTH}}</a></li><li><a href='#thisMonth'>{{.Lang.datepicker.dpText.TEXT_THIS_MONTH}}</a></li></ul>").appendTo('body');
            $period.find('li > a').click(function(event)
            {
                var target = $(query).closest('form').find('#' + $period.data('target'));
                if(target.length)
                {
                    if(target.next('input[type=hidden]').length)
                    {
                        target.next('input[type=hidden]').val($(this).attr('href').replace('#', '$'));
                        target.attr('placeholder', $(this).attr('href').replace('#', '$'));
                    }
                    else
                    {
                        target.val($(this).attr('href').replace('#', '$'));
                    }

                    $(query).closest('form').find('#operator' + $period.data('fieldNO')).val('between');
                    $period.hide();
                }
                event.stopPropagation();
                return false;
            });
        }
        $(query).datetimepicker('remove').datepicker(dtOptions).on('show', function(e)
        {
            var $e = $(e.target);
            var ePos = $e.offset();
            $period.css({'left': ePos.left + 211, 'top': ePos.top + 29, 'min-height': $('.datetimepicker').outerHeight()}).show().data('target', $e.attr('id')).data('fieldNO', fieldNO).find('li.active').removeClass('active');
            if($e.attr('placeholder'))
            {
                $period.find("li > a[href='" + $e.attr('placeholder').replace('$', '#') + "']").closest('li').addClass('active');
            }
            else
            {
                $period.find("li > a[href='" + $e.val().replace('$', '#') + "']").closest('li').addClass('active');
            }
        }).on('changeDate', function()
        {
            var opt = $(query).closest('form').find('#operator' + $period.data('fieldNO'));
            var target = $('#' + $period.data('target'));
            if(target.length)
            {
                if(target.next('input[type=hidden]').length)
                {
                    target.next('input[type=hidden]').val(target.val());
                }
            }
            if(opt.val() == 'between') opt.val('<=');
            $period.hide();
        }).on('hide', function(){setTimeout(function(){$period.hide();}, 200);});
    }

    /**
     * When the value of the fields select changed, set the operator and value of the new field.
     *
     * @param  string $obj
     * @param  int    $fieldNO
     * @access public
     * @return void
     */
    var setField = window.setField = function(obj, fieldNO, moduleparams)
    {
        var params    = moduleparams;
        var $obj      = $(obj);
        var fieldName = $obj.val();
        $searchForm.find('#operator' + fieldNO).val(params[fieldName]['operator']);   // Set the operator according the param setting.
        $searchForm.find('#valueBox' + fieldNO).html($searchForm.find('#box' + fieldName).children().clone());
        $searchForm.find('#valueBox' + fieldNO).children().attr({name : 'value' + fieldNO, id : 'value' + fieldNO});

        if(typeof(params[fieldName]['class']) != undefined && params[fieldName]['class'] == 'date')
        {
            setDateField($searchForm.find("#value" + fieldNO), fieldNO);
            $searchForm.find("#value" + fieldNO).addClass('date');   // Shortcut the width of the datepicker to make sure align with others.
            var maxNO      = 2 * groupItems;
            var nextNO     = fieldNO > groupItems ? fieldNO - groupItems + 1 : fieldNO + groupItems;
            var nextValue  = $searchForm.find('#value' + nextNO).val();
            var operator   = $searchForm.find("#operator" + fieldNO).val();
            if(nextNO <= maxNO && fieldNO < maxNO && (nextValue == '' || nextValue == 0) && operator == ">=")
            {
                $searchForm.find('#field' + nextNO).val($searchForm.find('#field' + fieldNO).val());
                $searchForm.find('#operator' + nextNO).val('<=');
                $searchForm.find('#valueBox' + nextNO).html($searchForm.find('#box' + fieldName).children().clone());
                $searchForm.find('#valueBox' + nextNO).children().attr({name : 'value' + nextNO, id : 'value' + nextNO});
                setDateField($searchForm.find("#value" + nextNO), nextNO);
                $searchForm.find("#value" + nextNO).addClass('date');
            }
        }
        else if(params[fieldName]['control'] == 'select')
        {
            $searchForm.find("#value" + fieldNO).chosen().on('chosen:showing_dropdown', function()
            {
                var $this = $(this);
                var $chosen = $this.next('.chosen-container').removeClass('chosen-up');
                var $drop = $chosen.find('.chosen-drop');
                $chosen.toggleClass('chosen-up', $drop.height() + $drop.offset().top - $(document).scrollTop() > $(window).height());
            });
        }
    };

    /*
     * Reset form
     */
    window.resetForm = function()
    {
        for(i = 1; i <= groupItems * 2; i ++)
        {
            $searchForm.find('#value' + i).val('').trigger('chosen:updated');
            $searchForm.find('#dateValue' + i).val('').attr('placeholder','');
        }
    };

    $searchForm.on('click', '.btn-expand-form', function() {expandForm();});
    $searchForm.on('click', '.btn-reset-form', function() {resetForm();});
    $searchForm.on('change', 'select[id^="operator"]', function()
    {
        var $select = $(this);
        var value = $select.val();
        var $tr = $select.closest('tr');
        if(value == '>=' && $tr.find('input[id^="value"].date').length)
        {
            var fieldNO   = parseInt($(this).attr('id').replace('operator', ''));
            var fieldName = $tr.find("select[id^='field']").val();
            var maxNO      = 2 * groupItems;
            var nextNO     = fieldNO > groupItems ? fieldNO - groupItems + 1 : fieldNO + groupItems;
            var nextValue  = searchForm.find('#value' + nextNO).val();
            if(nextNO <= maxNO && fieldNO < maxNO && (nextValue == '' || nextValue == 0))
            {
                searchForm.find('#field' + nextNO).val(searchForm.find('#field' + fieldNO).val());
                searchForm.find('#operator' + nextNO).val('<=');
                searchForm.find('#valueBox' + nextNO).html(searchForm.find('#box' + fieldName).children().clone());
                searchForm.find('#valueBox' + nextNO).children().attr({name : 'value' + nextNO, id : 'value' + nextNO});
                setDateField(searchForm.find("#value" + nextNO), nextNO);
                searchForm.find("#value" + nextNO).addClass('date');
            }
        }
    });

    $searchForm.find('.btn-save-form').modalTrigger({width:650, type:'iframe', title: setQueryTitle});

    $searchForm.on('click', '.user-query .icon-close', function(e)
    {
        var $query = $(this).closest('.user-query');
        var queryId = $query.data('queryId');
        var deleteQueryLink = $.createLink('search', 'deleteQuery', 'queryID=' + queryId);
        $.get(deleteQueryLink, function(data)
        {
            if(data == 'success') $query.remove();
        });
        e.stopPropagation();
    });

    /* Init datepicker for search. */
    $searchForm.find('.table-condensed input.date').each(function()
    {
        setDateField($(this), $(this).attr('id').substr(5));
    })
});
</script>
